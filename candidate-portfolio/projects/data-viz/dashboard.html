<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Financial Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
      .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
      h1 { margin: 0 0 12px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border-bottom: 1px solid #eee; padding: 6px 8px; text-align: right; }
      th:first-child, td:first-child { text-align: left; }
    </style>
  </head>
  <body>
    <h1>Financial Data Dashboard</h1>
    <p>Load <code>artifacts/dashboard.json</code> and <code>artifacts/prices.csv</code> generated by <code>analyzer.py</code>.</p>
    <div class="grid">
      <div class="card">
        <div id="priceChart" style="height:400px"></div>
      </div>
      <div class="card">
        <div id="corrHeatmap" style="height:400px"></div>
      </div>
      <div class="card">
        <h3>Summary Metrics</h3>
        <table id="summaryTable"></table>
      </div>
      <div class="card">
        <div id="rollingVol" style="height:400px"></div>
      </div>
    </div>

    <script>
      async function loadCSV(path) {
        const text = await fetch(path).then(r => r.text());
        const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
        const header = rows.shift();
        return { header, rows };
      }

      async function init() {
        const data = await fetch('artifacts/dashboard.json').then(r => r.json());
        const prices = await loadCSV('artifacts/prices.csv');

        const dates = prices.rows.map(r => r[0]);
        const traces = [];
        for (let i = 1; i < prices.header.length; i++) {
          const name = prices.header[i];
          traces.push({ x: dates, y: prices.rows.map(r => parseFloat(r[i])), name, type: 'scatter', mode: 'lines' });
        }
        Plotly.newPlot('priceChart', traces, { title: 'Adjusted Close Prices', legend: {orientation: 'h'} });

        const symbols = data.symbols;
        const z = symbols.map(i => symbols.map(j => data.corr[i]?.[j] ?? null));
        Plotly.newPlot('corrHeatmap', [{ z, x: symbols, y: symbols, type: 'heatmap', colorscale: 'RdBu', zmid: 0 }], { title: 'Return Correlation' });

        const table = document.getElementById('summaryTable');
        const header = document.createElement('tr');
        header.innerHTML = '<th>Symbol</th><th>CAGR</th><th>Vol</th><th>Sharpe</th><th>MaxDD</th><th>WinRate</th>';
        table.appendChild(header);
        symbols.forEach(s => {
          const m = data.summary[s];
          const tr = document.createElement('tr');
          const pct = v => (v*100).toFixed(1) + '%';
          tr.innerHTML = `<td style="text-align:left">${s}</td><td>${pct(m.cagr)}</td><td>${(m.vol).toFixed(2)}</td><td>${m.sharpe.toFixed(2)}</td><td>${pct(m.max_drawdown)}</td><td>${pct(m.win_rate)}</td>`;
          table.appendChild(tr);
        });

        // Rolling volatility from rolling.csv if present
        try {
          const rolling = await loadCSV('artifacts/rolling.csv');
          const idxVol = rolling.header.findIndex(h => h.endsWith('vol'));
          const rvDates = rolling.rows.map(r => r[0]);
          const volTraces = [];
          for (let i = 1; i < rolling.header.length; i++) {
            if (!rolling.header[i].includes('vol,')) continue;
          }
          // If multi-index columns were flattened to strings, pick those containing 'vol'
          const seen = new Set();
          rolling.header.forEach((h, i) => {
            if (i === 0) return;
            if (h.toLowerCase().includes('vol') && !seen.has(h)) {
              seen.add(h);
              volTraces.push({ x: rvDates, y: rolling.rows.map(r => parseFloat(r[i] || '0')), name: h.replace('vol,', ''), type: 'scatter', mode: 'lines' });
            }
          });
          if (volTraces.length)
            Plotly.newPlot('rollingVol', volTraces, { title: 'Rolling Volatility (ann.)', legend: {orientation: 'h'} });
        } catch (e) {
          // no rolling file; ignore
        }
      }

      init();
    </script>
  </body>
  </html>


